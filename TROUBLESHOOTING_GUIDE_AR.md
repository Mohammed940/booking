# دليل استكشاف الأخطاء وإصلاحها لبوت الحجز الطبي

## المشكلة: البوت يبقى عالقًا في رسالة "جاري تحميل المراكز الصحية يرجى الانتظار"

### الأسباب المحتملة:

1. **مشكلة في الاتصال بجداول Google Sheets**
2. **بيانات اعتماد Google غير صحيحة أو منتهية الصلاحية**
3. **معرف جدول البيانات غير صحيح**
4. **جدول البيانات غير مشارك مع حساب الخدمة**
5. **جدول البيانات يحتوي على بيانات غير صحيحة**
6. **مشكلة في الشبكة أو جدران الحماية**

### خطوات الاستكشاف:

#### 1. التحقق من متغيرات البيئة
تأكد من أن المتغيرات التالية مضبوطة بشكل صحيح:
```
TELEGRAM_TOKEN=your_telegram_bot_token
SPREADSHEET_ID=your_google_spreadsheet_id
GOOGLE_APPLICATION_CREDENTIALS_BASE64=base64_encoded_google_credentials
```

#### 2. التحقق من بيانات اعتماد Google
- تأكد من أن ملف بيانات اعتماد Google Service Account صحيح
- تأكد من أن الحساب لديه صلاحيات الوصول إلى جدول البيانات
- تحقق من أن معرف المشروع ومفتاح الخصوصية صحيحان

#### 3. التحقق من جدول البيانات
- تأكد من أن معرف جدول البيانات صحيح
- تأكد من أن جدول البيانات مشارك مع بريد حساب الخدمة
- تحقق من تنسيق البيانات في الجدول

#### 4. التحقق من تنسيق الجدول
يجب أن يحتوي الجدول على الأعمدة التالية:
- العمود A: اسم المركز الصحي
- العمود B: اسم العيادة
- العمود C: التاريخ (بتنسيق DD/MM/YYYY)
- العمود D: الوقت
- العمود E: الحالة (متاح/محجوز)
- العمود F: معرف المحادثة (سيتم ملؤه تلقائيًا عند الحجز)

### حلول مقترحة:

#### 1. إعادة تشغيل البوت
أحيانًا يكون الحل بسيطًا بإعادة تشغيل البوت لمسح أي حالات عالقة.

#### 2. التحقق من سجلات البوت
ابحث في سجلات البوت (logs) عن أي رسائل خطأ توضح الطبيعة الدقيقة للمشكلة.

#### 3. اختبار الاتصال بجداول Google
جرب تشغيل الأمر التالي لاختبار الاتصال:
```bash
node test-google-sheets.js
```

#### 4. تقليل وقت التخزين المؤقت
في ملف googleSheetsService.js، يمكنك تقليل وقت التخزين المؤقت:
```javascript
// تقليل من 1 دقيقة إلى 30 ثانية
this.CACHE_EXPIRATION = 30 * 1000;
```

#### 5. زيادة وقت انتهاء المهلة
في ملف googleSheetsService.js، يمكنك زيادة وقت انتهاء المهلة:
```javascript
// زيادة من 10-15 ثانية إلى 20-25 ثانية
setTimeout(() => reject(new Error('Google Sheets request timeout')), 25000);
```

### رسائل الخطأ الشائعة وحلولها:

#### "Google Sheets credentials not found"
- تأكد من تعيين متغير البيئة GOOGLE_APPLICATION_CREDENTIALS_BASE64
- تحقق من صحة ترميز Base64 لبيانات الاعتماد

#### "Spreadsheet not found"
- تحقق من صحة معرف جدول البيانات
- تأكد من أن جدول البيانات متوفر

#### "Access denied"
- تأكد من أن جدول البيانات مشارك مع بريد حساب الخدمة
- تحقق من أن حساب الخدمة لديه صلاحيات التحرير

#### "Google Sheets request timeout"
- تحقق من اتصال الإنترنت
- تأكد من عدم وجود جدران حماية تحجب الطلب
- جرب زيادة وقت انتهاء المهلة

### معلومات إضافية للتتبع:

لتمكين المزيد من سجلات التتبع، يمكنك إضافة السطور التالية إلى ملف .env:
```
DEBUG=googleapis,node-telegram-bot-api
LOG_LEVEL=debug
```

### الاتصال بالدعم:

إذا استمرت المشكلة، يرجى تقديم المعلومات التالية:
1. معرف البوت
2. معرف جدول البيانات
3. نسخة من سجلات البوت (logs)
4. لقطة شاشة لتنسيق جدول البيانات
5. نسخة من ملف بيانات اعتماد Google (بدون المفاتيح الحساسة)